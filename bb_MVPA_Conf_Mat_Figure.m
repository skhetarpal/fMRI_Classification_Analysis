function datavar = bb_MVPA_Conf_Mat_Figure(study, data, subNum, datavar, ii)

%%%%%%%
% Usage
%%%%%%%
fxname = mfilename;
if (nargin < 3)
    fprintf('\n');
    fprintf('Usage: data = %s(study, data, subNum, makefigs, forprint)\n', fxname);
    fprintf('       data = %s(study, data, subNum,        1,        0)\n', fxname);
    fprintf('study contains important variables for the study\n');
    fprintf('study should be contained within a study-level parameter file\n');
    fprintf('data contains important variables for the subject\n');
    fprintf('data should be contained within a study-level parameter file\n');
    fprintf('subNum is the subject number.\n');
    fprintf('forprint is either 1 indicating format for publication or 0 indicating format for web\n');
    return;
end
msg = nargoutchk(1, 1, nargout);
if ~isempty(msg)
    fprintf('%s: %s', fxname,msg);
    return;
end

mycolormap = [1         1         1     ; ...
    0.2300    0.3100    0.7600; ...
    0.2400    0.3100    0.7700; ...
    0.2400    0.3200    0.7700; ...
    0.2500    0.3300    0.7800; ...
    0.2500    0.3300    0.7800; ...
    0.2600    0.3400    0.7900; ...
    0.2600    0.3500    0.8000; ...
    0.2700    0.3500    0.8000; ...
    0.2700    0.3600    0.8100; ...
    0.2800    0.3700    0.8100; ...
    0.2800    0.3700    0.8200; ...
    0.2800    0.3800    0.8200; ...
    0.2900    0.3900    0.8300; ...
    0.2900    0.3900    0.8300; ...
    0.3000    0.4000    0.8400; ...
    0.3000    0.4100    0.8400; ...
    0.3100    0.4100    0.8500; ...
    0.3100    0.4200    0.8600; ...
    0.3200    0.4300    0.8600; ...
    0.3200    0.4300    0.8600; ...
    0.3300    0.4400    0.8700; ...
    0.3300    0.4500    0.8700; ...
    0.3400    0.4500    0.8800; ...
    0.3400    0.4600    0.8800; ...
    0.3500    0.4700    0.8900; ...
    0.3500    0.4700    0.8900; ...
    0.3600    0.4800    0.9000; ...
    0.3600    0.4800    0.9000; ...
    0.3700    0.4900    0.9100; ...
    0.3700    0.5000    0.9100; ...
    0.3800    0.5000    0.9100; ...
    0.3800    0.5100    0.9200; ...
    0.3900    0.5200    0.9200; ...
    0.3900    0.5200    0.9200; ...
    0.4000    0.5300    0.9300; ...
    0.4000    0.5300    0.9300; ...
    0.4100    0.5400    0.9400; ...
    0.4100    0.5500    0.9400; ...
    0.4200    0.5500    0.9400; ...
    0.4200    0.5600    0.9500; ...
    0.4300    0.5600    0.9500; ...
    0.4300    0.5700    0.9500; ...
    0.4400    0.5800    0.9500; ...
    0.4500    0.5800    0.9600; ...
    0.4500    0.5900    0.9600; ...
    0.4600    0.5900    0.9600; ...
    0.4600    0.6000    0.9700; ...
    0.4700    0.6000    0.9700; ...
    0.4700    0.6100    0.9700; ...
    0.4800    0.6200    0.9700; ...
    0.4800    0.6200    0.9800; ...
    0.4900    0.6300    0.9800; ...
    0.4900    0.6300    0.9800; ...
    0.5000    0.6400    0.9800; ...
    0.5000    0.6400    0.9800; ...
    0.5100    0.6500    0.9800; ...
    0.5200    0.6500    0.9900; ...
    0.5200    0.6600    0.9900; ...
    0.5300    0.6600    0.9900; ...
    0.5300    0.6700    0.9900; ...
    0.5400    0.6700    0.9900; ...
    0.5400    0.6800    0.9900; ...
    0.5500    0.6800    0.9900; ...
    0.5500    0.6900    1.0000; ...
    0.5600    0.6900    1.0000; ...
    0.5600    0.7000    1.0000; ...
    0.5700    0.7000    1.0000; ...
    0.5700    0.7100    1.0000; ...
    0.5800    0.7100    1.0000; ...
    0.5900    0.7200    1.0000; ...
    0.5900    0.7200    1.0000; ...
    0.6000    0.7300    1.0000; ...
    0.6000    0.7300    1.0000; ...
    0.6100    0.7300    1.0000; ...
    0.6100    0.7400    1.0000; ...
    0.6200    0.7400    1.0000; ...
    0.6200    0.7500    1.0000; ...
    0.6300    0.7500    1.0000; ...
    0.6300    0.7600    1.0000; ...
    0.6400    0.7600    1.0000; ...
    0.6400    0.7600    1.0000; ...
    0.6500    0.7700    1.0000; ...
    0.6600    0.7700    1.0000; ...
    0.6600    0.7700    1.0000; ...
    0.6700    0.7800    0.9900; ...
    0.6700    0.7800    0.9900; ...
    0.6800    0.7900    0.9900; ...
    0.6800    0.7900    0.9900; ...
    0.6900    0.7900    0.9900; ...
    0.6900    0.8000    0.9900; ...
    0.7000    0.8000    0.9900; ...
    0.7000    0.8000    0.9800; ...
    0.7100    0.8100    0.9800; ...
    0.7100    0.8100    0.9800; ...
    0.7200    0.8100    0.9800; ...
    0.7200    0.8100    0.9800; ...
    0.7300    0.8200    0.9700; ...
    0.7300    0.8200    0.9700; ...
    0.7400    0.8200    0.9700; ...
    0.7400    0.8200    0.9700; ...
    0.7500    0.8300    0.9600; ...
    0.7500    0.8300    0.9600; ...
    0.7600    0.8300    0.9600; ...
    0.7600    0.8300    0.9600; ...
    0.7700    0.8400    0.9500; ...
    0.7700    0.8400    0.9500; ...
    0.7800    0.8400    0.9500; ...
    0.7800    0.8400    0.9500; ...
    0.7800    0.8400    0.9400; ...
    0.7900    0.8500    0.9400; ...
    0.7900    0.8500    0.9400; ...
    0.8000    0.8500    0.9300; ...
    0.8000    0.8500    0.9300; ...
    0.8100    0.8500    0.9200; ...
    0.8100    0.8500    0.9200; ...
    0.8200    0.8600    0.9200; ...
    0.8200    0.8600    0.9100; ...
    0.8300    0.8600    0.9100; ...
    0.8300    0.8600    0.9100; ...
    0.8300    0.8600    0.9000; ...
    0.8400    0.8600    0.9000; ...
    0.8400    0.8600    0.8900; ...
    0.8500    0.8600    0.8900; ...
    0.8500    0.8600    0.8800; ...
    0.8500    0.8600    0.8800; ...
    0.8600    0.8600    0.8700; ...
    0.8600    0.8700    0.8700; ...
    0.8700    0.8700    0.8700; ...
    0.8700    0.8600    0.8600; ...
    0.8700    0.8600    0.8500; ...
    0.8800    0.8600    0.8500; ...
    0.8800    0.8600    0.8400; ...
    0.8900    0.8600    0.8400; ...
    0.8900    0.8500    0.8300; ...
    0.8900    0.8500    0.8300; ...
    0.9000    0.8500    0.8200; ...
    0.9000    0.8500    0.8200; ...
    0.9000    0.8400    0.8100; ...
    0.9100    0.8400    0.8000; ...
    0.9100    0.8400    0.8000; ...
    0.9100    0.8400    0.7900; ...
    0.9200    0.8300    0.7900; ...
    0.9200    0.8300    0.7800; ...
    0.9200    0.8300    0.7700; ...
    0.9300    0.8200    0.7700; ...
    0.9300    0.8200    0.7600; ...
    0.9300    0.8200    0.7600; ...
    0.9400    0.8100    0.7500; ...
    0.9400    0.8100    0.7400; ...
    0.9400    0.8100    0.7400; ...
    0.9400    0.8000    0.7300; ...
    0.9400    0.8000    0.7300; ...
    0.9500    0.8000    0.7200; ...
    0.9500    0.7900    0.7100; ...
    0.9500    0.7900    0.7100; ...
    0.9500    0.7900    0.7000; ...
    0.9500    0.7800    0.7000; ...
    0.9600    0.7800    0.6900; ...
    0.9600    0.7700    0.6800; ...
    0.9600    0.7700    0.6800; ...
    0.9600    0.7700    0.6700; ...
    0.9600    0.7600    0.6700; ...
    0.9600    0.7600    0.6600; ...
    0.9600    0.7500    0.6500; ...
    0.9600    0.7500    0.6500; ...
    0.9700    0.7400    0.6400; ...
    0.9700    0.7400    0.6300; ...
    0.9700    0.7300    0.6300; ...
    0.9700    0.7300    0.6200; ...
    0.9700    0.7200    0.6200; ...
    0.9700    0.7200    0.6100; ...
    0.9700    0.7100    0.6000; ...
    0.9700    0.7100    0.6000; ...
    0.9700    0.7000    0.5900; ...
    0.9700    0.7000    0.5900; ...
    0.9700    0.6900    0.5800; ...
    0.9700    0.6900    0.5700; ...
    0.9700    0.6800    0.5700; ...
    0.9700    0.6800    0.5600; ...
    0.9700    0.6700    0.5500; ...
    0.9700    0.6700    0.5500; ...
    0.9700    0.6600    0.5400; ...
    0.9700    0.6600    0.5400; ...
    0.9700    0.6500    0.5300; ...
    0.9700    0.6400    0.5200; ...
    0.9700    0.6400    0.5200; ...
    0.9600    0.6300    0.5100; ...
    0.9600    0.6300    0.5100; ...
    0.9600    0.6200    0.5000; ...
    0.9600    0.6200    0.4900; ...
    0.9600    0.6100    0.4900; ...
    0.9600    0.6000    0.4800; ...
    0.9600    0.6000    0.4800; ...
    0.9500    0.5900    0.4700; ...
    0.9500    0.5800    0.4600; ...
    0.9500    0.5800    0.4600; ...
    0.9500    0.5700    0.4500; ...
    0.9500    0.5600    0.4500; ...
    0.9500    0.5600    0.4400; ...
    0.9400    0.5500    0.4300; ...
    0.9400    0.5500    0.4300; ...
    0.9400    0.5400    0.4200; ...
    0.9400    0.5300    0.4200; ...
    0.9300    0.5200    0.4100; ...
    0.9300    0.5200    0.4100; ...
    0.9300    0.5100    0.4000; ...
    0.9300    0.5000    0.3900;...
    0.9200    0.5000    0.3900; ...
    0.9200    0.4900    0.3800; ...
    0.9200    0.4800    0.3800; ...
    0.9200    0.4800    0.3700; ...
    0.9100    0.4700    0.3700; ...
    0.9100    0.4600    0.3600; ...
    0.9100    0.4500    0.3500; ...
    0.9000    0.4500    0.3500; ...
    0.9000    0.4400    0.3400; ...
    0.9000    0.4300    0.3400; ...
    0.8900    0.4200    0.3300; ...
    0.8900    0.4200    0.3300; ...
    0.8800    0.4100    0.3200; ...
    0.8800    0.4000    0.3200; ...
    0.8800    0.3900    0.3100; ...
    0.8700    0.3900    0.3100; ...
    0.8700    0.3800    0.3000; ...
    0.8700    0.3700    0.3000; ...
    0.8600    0.3600    0.2900; ...
    0.8600    0.3500    0.2800; ...
    0.8500    0.3500    0.2800; ...
    0.8500    0.3400    0.2700; ...
    0.8400    0.3300    0.2700; ...
    0.8400    0.3200    0.2600; ...
    0.8300    0.3100    0.2600; ...
    0.8300    0.3000    0.2500; ...
    0.8300    0.3000    0.2500; ...
    0.8200    0.2900    0.2400; ...
    0.8200    0.2800    0.2400; ...
    0.8100    0.2700    0.2300; ...
    0.8100    0.2600    0.2300; ...
    0.8000    0.2500    0.2300; ...
    0.8000    0.2400    0.2200; ...
    0.7900    0.2300    0.2200; ...
    0.7900    0.2200    0.2100; ...
    0.7800    0.2100    0.2100; ...
    0.7700    0.2000    0.2000; ...
    0.7700    0.1900    0.2000; ...
    0.7600    0.1800    0.1900; ...
    0.7600    0.1700    0.1900; ...
    0.7500    0.1600    0.1800; ...
    0.7500    0.1400    0.1800; ...
    0.7400    0.1300    0.1800; ...
    0.7400    0.1200    0.1700; ...
    0.7300    0.1000    0.1700; ...
    0.7200    0.0900    0.1600; ...
    0.7200    0.0700    0.1600; ...
    0.7100    0.0400    0.1500; ...
    %     1         1         1     ];
    0.7100    0.0200    0.1500];

for ap=1:length(study.part(data.sub(subNum).info.part).newapAnalysis)
    isess = study.part(data.sub(subNum).info.part).newapAnalysis(ap);
    for kk=1:length(data.sub(subNum).study.part(data.sub(subNum).info.part).apAnalyses(isess).apROI)
        datavar(ii).mvpa.apAnalyses(isess).apROI{kk}.confusion_matrix.title  = sprintf('Confusion Matrix for Region: %s', data.sub(subNum).study.part(data.sub(subNum).info.part).apAnalyses(isess).apROI{kk}.name);
        cf_name = sprintf('%s_ROI_%s_confusion_matrix.jpg', data.sub(subNum).info.name, data.sub(subNum).study.part(data.sub(subNum).info.part).apAnalyses(isess).apROI{kk}.name);
        datavar(ii).mvpa.apAnalyses(isess).apROI{kk}.confusion_matrix.figfilename = sprintf('%s/%s/mvpa_results/%s/%s', data.sub(subNum).study.info.studydir, data.sub(subNum).info.name, datavar(ii).tag, cf_name);
        
        % Plot Confusion Matrix
        figure;
        handles.figure = imagesc(datavar(ii).mvpa.apAnalyses(isess).apROI{kk}.confusion_matrix.acc);
        
        set(gcf, 'Colormap', mycolormap);
        caxis([0 1]); % Set Upper/Lower Bound for Color Map
        
        % Remove Axis Information
        set(gca,'XTickLabel','');
        set(gca,'YTickLabel','');
        set(gca,'XTick',[],'YTick',[]);
        
        set(gca, ...
            'FontName'  , 'Helvetica'   , ...
            'FontSize'  ,   16          , ...
            'FontWeight', 'bold');
        set(gca, ...
            'Box'       , 'off'         , ...
            'TickDir'   , 'out'         , ...
            'TickLength', [.02 .02]     , ...
            'XMinorTick', 'off'          , ...
            'YMinorTick', 'off'          , ...
            'YGrid'     , 'off'         , ...
            'XColor'    , [.3 .3 .3]    , ...
            'YColor'    , [.3 .3 .3]);
        
        % Reposition Bar Graph
        axis square; % Make Square Plot
        pos = get(gca, 'Position');
        set(gca, 'Position', [1.5*pos(1), 1.25*pos(2), .8*pos(3), .8*pos(4)]); % Reduce Size of Plot to Accomodate Labels
        Xt = 1:length(datavar(ii).mvpa.apAnalyses(isess).apROI{kk}.confusion_matrix.acc);
        ax = axis; % Current axis limits
        axis(axis); % Set the axis limit modes (e.g. XLimMode) to manual
        Yl = ax(3:4); % Y-axis limits
        Xl = ax(1:2); % X-axis limits
        
        
        % Char Lengends
        
        %Determine the longest legend name
        max_len = 0;
        for jj=1:length(datavar(ii).mvpa.confusion_matrix.cond)
            max_len = max(max_len, length(datavar(ii).mvpa.confusion_matrix.cond(jj).name));
        end
        for jj=1:length(datavar(ii).mvpa.confusion_matrix.cond)
            padding = repmat(' ', 1, max_len - length(datavar(ii).mvpa.confusion_matrix.cond(jj).name));
            cf_legend_top(jj,1:max_len) = char([upper(strrep(datavar(ii).mvpa.confusion_matrix.cond(jj).name,'_',' ')), padding]);
            cf_legend_left(jj,1:max_len) = char([padding, upper(strrep(datavar(ii).mvpa.confusion_matrix.cond(jj).name,'_',' '))]);
        end
        
        % Place the Text Labels
        handles.TopText = text(Xt, Yl(1)*ones(1,length(Xt)), cf_legend_top(1:size(cf_legend_top, 1),:));
        set(handles.TopText, 'HorizontalAlignment', 'left', 'VerticalAlignment', 'bottom', 'Rotation', 45, 'FontName', 'Helvetica', 'FontSize', 24, 'FontWeight', 'bold');
        handles.LeftText = text(Xl(1)*ones(1,length(Xt)), Xt, cf_legend_left(1:size(cf_legend_left, 1),:));
        set(handles.LeftText, 'HorizontalAlignment', 'right', 'VerticalAlignment', 'bottom', 'Rotation', 45, 'FontName', 'Helvetica', 'FontSize', 24, 'FontWeight', 'bold');
        
        set(gca,'box','off');
        set(gca,'xcolor','w','ycolor','w','xtick',[],'ytick',[]);
        axis off;
        
        %Draw in the accuracy values
        for jj=1:size(datavar(ii).mvpa.apAnalyses(isess).apROI{kk}.confusion_matrix.acc,1)
            for zz=1:size(datavar(ii).mvpa.apAnalyses(isess).apROI{kk}.confusion_matrix.acc,2)
                handles.acc(zz,jj).acc = text(zz,jj,num2str(datavar(ii).mvpa.apAnalyses(isess).apROI{kk}.confusion_matrix.acc(jj,zz),'%0.2f'),...
                    'HorizontalAlignment','center');
                set(handles.acc(zz,jj).acc, 'FontSize', 30, 'FontWeight', 'bold', 'FontName', 'Helvetica');
                %                 end
            end
        end
        
        % Save Image
        set(gcf, 'PaperPositionMode', 'auto');
        datavar(ii).mvpa.apAnalyses(isess).apROI{kk}.confusion_matrix.fig = figure(gcf);
        saveas(datavar(ii).mvpa.apAnalyses(isess).apROI{kk}.confusion_matrix.fig, 'temp.jpg');
        close all;
        
        %             % Rotate Image
        %             theta = -45;
        %             I = imread('temp.jpg');
        %             Irot = imrotate(I,theta);
        %             Mrot = ~imrotate(true(size(I)),theta);
        %             Irot(Mrot&~imclearborder(Mrot)) = 255;
        %             delete('temp.jpg');
        
        % Crop the Image
        I = imread('temp.jpg');
        %             I(~imclearborder(I)) = 255;
        %             rect = [.1*size(I,1) .2*size(I,2) .9*size(I,1) .8*size(I,2)];
        %             Icrop = imcrop(I, rect);
        imwrite(I, datavar(ii).mvpa.apAnalyses(isess).apROI{kk}.confusion_matrix.figfilename);
        delete('temp.jpg');
    end
end
close all hidden;
close all force;